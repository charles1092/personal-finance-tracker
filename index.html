<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Tracker</title>
    <link rel="icon" href="/favicon.ico" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">

<script>
console.log('Finance Tracker Loading...');

// Configuration
const GOOGLE_CLIENT_ID = '876156174200-t8oqohkdctii3f3ovd46qo6e5vlpki80.apps.googleusercontent.com';
const GOOGLE_API_KEY = 'AIzaSyCukKz-4VWFolkf2Ya-y_hCYhu0DeErPQE';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

// Global state
let googleDriveConnected = false;
let tokenClient;
let gapiInited = false;
let gisInited = false;
let accessToken = null;

let appState = {
    accounts: {
        upBank: { balance: 8500, lastUpdated: '4 Aug 2025' },
        commBankPocket: { balance: 45000, lastUpdated: '4 Aug 2025' },
        commsec: { balance: 12000, lastUpdated: '4 Aug 2025' },
        commBankCDIA: { balance: 0, lastUpdated: '4 Aug 2025' },
        stakeUSD: { balanceUSD: 5000, balanceAUD: 8000, exchangeRate: 1.6, lastUpdated: '4 Aug 2025' },
        stakeUSDCash: { balanceUSD: 0, balanceAUD: 0, exchangeRate: 1.6, lastUpdated: '4 Aug 2025' },
        stakeAUDCash: { balance: 0, lastUpdated: '4 Aug 2025' }
    },
    temporaryAssets: [
        { id: 1, description: "Security deposit - apartment", amount: 1500, returnDate: "2025-11-30" }
    ],
    income: {
        baseSalary: 90000,
        monthlySalary: 0,
        isCalculated: false,
        payDate: 1
    },
    incomeChanges: [],
    monthlyExpenses: {
        rent: 2200,
        utilities: 200,
        groceries: 600,
        transport: 150,
        entertainment: 400,
        other: 300
    },
    adjustments: [
        { id: 1, description: "November Holiday", amount: 2500, date: "2025-11-01", type: "expense", enabled: true },
        { id: 2, description: "Christmas Expenses", amount: 1200, date: "2025-12-01", type: "expense", enabled: true },
        { id: 3, description: "Tax Refund", amount: 3000, date: "2025-08-15", type: "income", enabled: true }
    ],
    investmentScenarios: {
        highPercentage: 10,
        lowPercentage: -10,
        cashBuffer: 5000,
        investmentRatio: 80
    },
    projectionMonths: 12,
    selectedDate: new Date().toISOString().slice(0, 10),
    lastSyncTime: Date.now()
};

// Chart variables
let wealthChart = null;
let detailedWealthChart = null;

// Helper Functions
function formatCurrency(amount) {
    if (amount === 0 || amount === null || amount === undefined || amount === '') return '$0';
    return `$${Math.round(amount).toLocaleString()}`;
}

function parseCurrency(value) {
    if (!value || value === '' || value === '$0') return 0;
    
    if (typeof value === 'string') {
        let cleanValue = value.replace(/[$,]/g, '');
        if (cleanValue === '-') return 0;
        const parsed = parseFloat(cleanValue);
        return isNaN(parsed) ? 0 : parsed;
    }
    
    return parseFloat(value) || 0;
}

// Australian Tax Calculation
function calculateMonthlySalary(annualSalary = appState.income.baseSalary) {
    if (!annualSalary) return 0;
    let tax = 0;
    
    if (annualSalary > 18200) {
        tax += Math.min(annualSalary - 18200, 45000 - 18200) * 0.16;
    }
    if (annualSalary > 45000) {
        tax += Math.min(annualSalary - 45000, 135000 - 45000) * 0.30;
    }
    if (annualSalary > 135000) {
        tax += Math.min(annualSalary - 135000, 190000 - 135000) * 0.37;
    }
    if (annualSalary > 190000) {
        tax += (annualSalary - 190000) * 0.45;
    }
    if (annualSalary > 23226) {
        tax += annualSalary * 0.02;
    }

    const afterTax = annualSalary - tax;
    return afterTax / 12;
}

function getCurrentTotals() {
    const totalCash = appState.accounts.upBank.balance + 
                     appState.accounts.commBankCDIA.balance + 
                     appState.accounts.stakeUSDCash.balanceAUD + 
                     appState.accounts.stakeAUDCash.balance;
    
    const totalInvestments = appState.accounts.commBankPocket.balance + 
                            appState.accounts.commsec.balance + 
                            appState.accounts.stakeUSD.balanceAUD;
    
    const tempAssetsTotal = appState.temporaryAssets.reduce((sum, asset) => sum + asset.amount, 0);
    const totalNetWorth = totalCash + totalInvestments + tempAssetsTotal;
    
    return { totalNetWorth, totalCash, totalInvestments, tempAssetsTotal };
}

// Tab Management
function showTab(tabName) {
    console.log('Switching to tab:', tabName);
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.className = 'tab-btn flex items-center space-x-2 px-4 py-2 rounded-md transition-all text-slate-600 hover:bg-slate-100';
    });
    
    document.getElementById('content-' + tabName).classList.add('active');
    document.getElementById('tab-' + tabName).className = 'tab-btn flex items-center space-x-2 px-4 py-2 rounded-md transition-all bg-blue-500 text-white shadow-sm';
    
    if (tabName === 'projections') {
        updateProjectionsTab();
    }
}

// Account Management
function updateAccount(accountKey, field, value) {
    const numValue = parseCurrency(value);
    appState.accounts[accountKey][field] = numValue;
    appState.accounts[accountKey].lastUpdated = new Date().toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
    
    if ((accountKey === 'stakeUSD' || accountKey === 'stakeUSDCash') && field === 'balanceUSD') {
        appState.accounts[accountKey].balanceAUD = Math.round(numValue * appState.accounts[accountKey].exchangeRate);
        const audInputId = accountKey === 'stakeUSD' ? 'account-stakeUSD-AUD' : 'account-stakeUSDCash-AUD';
        document.getElementById(audInputId).value = formatCurrency(appState.accounts[accountKey].balanceAUD);
    }
    
    updateAccountsDisplay();
    updateDashboard();
    saveData();
}

function refreshAllBalances() {
    const today = new Date().toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
    Object.keys(appState.accounts).forEach(key => {
        appState.accounts[key].lastUpdated = today;
    });
    updateAccountsDisplay();
    saveData();
}

// Income Management
function updateBaseSalary(value) {
    appState.income.baseSalary = parseCurrency(value);
    appState.income.isCalculated = false;
    document.getElementById('monthly-after-tax').value = '$0';
    saveData();
}

function calculateIncome() {
    const monthly = calculateMonthlySalary();
    appState.income.monthlySalary = monthly;
    appState.income.isCalculated = true;
    document.getElementById('monthly-after-tax').value = formatCurrency(monthly);
    updateDashboard();
    saveData();
}

function updatePayDate(value) {
    appState.income.payDate = parseInt(value);
    saveData();
}

// Projection Functions
function getEffectiveSalary(date) {
    if (!appState.income.isCalculated) return 0;
    
    const targetDate = new Date(date);
    let effectiveSalary = appState.income.baseSalary;
    
    const applicableChanges = appState.incomeChanges
        .filter(change => change.enabled && new Date(change.effectiveDate) <= targetDate)
        .sort((a, b) => new Date(a.effectiveDate) - new Date(b.effectiveDate));
    
    for (const change of applicableChanges) {
        effectiveSalary = change.newSalary;
    }
    
    return calculateMonthlySalary(effectiveSalary);
}

function generateProjections() {
    const results = [];
    const today = new Date();
    const currentTotals = getCurrentTotals();
    let runningCash = currentTotals.totalCash;
    let runningInvestments = currentTotals.totalInvestments;
    
    const monthlyExpenseTotal = Object.values(appState.monthlyExpenses).reduce((sum, exp) => sum + exp, 0);
    
    for (let i = 0; i <= appState.projectionMonths; i++) {
        const projDate = new Date(today.getFullYear(), today.getMonth() + i, 1);
        const monthStr = projDate.toISOString().slice(0, 7);
        
        const monthlySalary = getEffectiveSalary(projDate);
        
        if (i > 0) {
            runningCash += monthlySalary;
            runningCash -= monthlyExpenseTotal;
            
            const monthAdjustments = appState.adjustments.filter(a => 
                a.enabled && a.date.startsWith(monthStr)
            );
            
            monthAdjustments.forEach(adjustment => {
                if (adjustment.type === 'income') {
                    runningCash += adjustment.amount;
                } else {
                    runningCash -= adjustment.amount;
                }
            });
            
            if (runningCash > appState.investmentScenarios.cashBuffer) {
                const excessCash = runningCash - appState.investmentScenarios.cashBuffer;
                const investAmount = excessCash * (appState.investmentScenarios.investmentRatio / 100);
                runningInvestments += investAmount;
                runningCash = appState.investmentScenarios.cashBuffer + (excessCash - investAmount);
            }
        }
        
        const totalWealth = runningCash + runningInvestments + currentTotals.tempAssetsTotal;
        const investmentHigh = runningInvestments * (1 + appState.investmentScenarios.highPercentage / 100);
        const investmentLow = runningInvestments * (1 + appState.investmentScenarios.lowPercentage / 100);
        
        results.push({
            month: projDate.toLocaleDateString('en-AU', { month: 'short', year: 'numeric' }),
            date: projDate.toISOString().slice(0, 10),
            cash: Math.round(runningCash),
            investments: Math.round(runningInvestments),
            investmentHigh: Math.round(investmentHigh),
            investmentLow: Math.round(investmentLow),
            total: Math.round(totalWealth),
            totalHigh: Math.round(runningCash + investmentHigh + currentTotals.tempAssetsTotal),
            totalLow: Math.round(runningCash + investmentLow + currentTotals.tempAssetsTotal)
        });
    }
    
    return results;
}

function getCurrentMonthFlow() {
    const today = new Date();
    const currentMonth = today.toISOString().slice(0, 7);
    const monthlyExpenseTotal = Object.values(appState.monthlyExpenses).reduce((sum, exp) => sum + exp, 0);
    const monthlySalary = getEffectiveSalary(today);
    
    const monthIncomeAdjustments = appState.adjustments.filter(a => 
        a.enabled && a.date.startsWith(currentMonth) && a.type === 'income'
    ).reduce((sum, a) => sum + a.amount, 0);
    
    const monthExpenseAdjustments = appState.adjustments.filter(a => 
        a.enabled && a.date.startsWith(currentMonth) && a.type === 'expense'
    ).reduce((sum, a) => sum + a.amount, 0);
    
    return {
        income: monthlySalary + monthIncomeAdjustments,
        expenses: monthlyExpenseTotal + monthExpenseAdjustments,
        net: monthlySalary + monthIncomeAdjustments - monthlyExpenseTotal - monthExpenseAdjustments
    };
}

// Data Management
function saveData() {
    try {
        appState.lastSyncTime = Date.now();
        localStorage.setItem('advancedFinanceTracker', JSON.stringify(appState));
        
        if (googleDriveConnected && accessToken) {
            saveToGoogleDrive();
        }
    } catch (e) {
        console.error('Failed to save data:', e);
    }
}

function loadData() {
    try {
        const saved = localStorage.getItem('advancedFinanceTracker');
        if (saved) {
            const loadedState = JSON.parse(saved);
            appState = { ...appState, ...loadedState };
            
            if (!appState.accounts.commBankCDIA) {
                appState.accounts.commBankCDIA = { balance: 0, lastUpdated: '4 Aug 2025' };
            }
            if (!appState.accounts.stakeUSDCash) {
                appState.accounts.stakeUSDCash = { balanceUSD: 0, balanceAUD: 0, exchangeRate: 1.6, lastUpdated: '4 Aug 2025' };
            }
            if (!appState.accounts.stakeAUDCash) {
                appState.accounts.stakeAUDCash = { balance: 0, lastUpdated: '4 Aug 2025' };
            }
        }
    } catch (e) {
        console.error('Failed to load data:', e);
    }
}

// Export/Import Functions
function exportData() {
    const dataStr = JSON.stringify(appState, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `finance-tracker-backup-${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    alert('Data exported successfully! Check your Downloads folder.');
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const importedData = JSON.parse(text);
            
            if (confirm('This will replace all current data. Are you sure?')) {
                appState = importedData;
                saveData();
                location.reload();
            }
        } catch (error) {
            alert('Failed to import data. Please check the file format.');
            console.error('Import error:', error);
        }
    };
    input.click();
}

// Make all functions globally accessible immediately
window.showTab = showTab;
window.updateAccount = updateAccount;
window.refreshAllBalances = refreshAllBalances;
window.updateBaseSalary = updateBaseSalary;
window.calculateIncome = calculateIncome;
window.updatePayDate = updatePayDate;
window.exportData = exportData;
window.importData = importData;

console.log('Core functions loaded and exposed globally');
</script>

    <div class="p-4">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-4xl font-bold text-slate-800 mb-2">Personal Finance Tracker</h1>
                <p class="text-slate-600">Dynamic financial planning and wealth tracking for house deposit goal</p>
            </div>

            <!-- Navigation -->
            <div class="flex flex-wrap space-x-1 mb-6 bg-white rounded-lg p-1 shadow-sm">
                <button onclick="showTab('dashboard')" id="tab-dashboard" class="tab-btn flex items-center space-x-2 px-4 py-2 rounded-md transition-all bg-blue-500 text-white shadow-sm">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22,7 13.5,15.5 8.5,10.5 2,17"></polyline>
                        <polyline points="16,7 22,7 22,13"></polyline>
                    </svg>
                    <span>Dashboard</span>
                </button>
                <button onclick="showTab('accounts')" id="tab-accounts" class="tab-btn flex items-center space-x-2 px-4 py-2 rounded-md transition-all text-slate-600 hover:bg-slate-100">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                    <span>Accounts</span>
                </button>
                <button onclick="showTab('planning')" id="tab-planning" class="tab-btn flex items-center space-x-2 px-4 py-2 rounded-md transition-all text-slate-600 hover:bg-slate-100">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <span>Planning</span>
                </button>
                <button onclick="showTab('adjustments')" id="tab-adjustments" class="tab-btn flex items-center space-x-2 px-4 py-2 rounded-md transition-all text-slate-600 hover:bg-slate-100">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    <span>Adjustments</span>
                </button>
                <button onclick="showTab('projections')" id="tab-projections" class="tab-btn flex items-center space-x-2 px-4 py-2 rounded-md transition-all text-slate-600 hover:bg-slate-100">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22,7 13.5,15.5 8.5,10.5 2,17"></polyline>
                        <polyline points="16,7 22,7 22,13"></polyline>
                    </svg>
                    <span>Projections</span>
                </button>
            </div>

            <!-- Dashboard Tab -->
            <div id="content-dashboard" class="tab-content active">
                <div class="space-y-6">
                    <!-- Data Management Quick Actions -->
                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm font-medium text-amber-800">Data Management</p>
                                <p class="text-xs text-amber-600 mt-1" id="sync-status">Local storage only - Google Drive not connected</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="exportData()" class="px-3 py-2 bg-amber-500 text-white rounded-md hover:bg-amber-600 text-sm">
                                    Export Data
                                </button>
                                <button onclick="importData()" class="px-3 py-2 bg-amber-500 text-white rounded-md hover:bg-amber-600 text-sm">
                                    Import Data
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Key Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-slate-500">Total Net Worth</h3>
                                <svg class="text-green-500" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="22,7 13.5,15.5 8.5,10.5 2,17"></polyline>
                                    <polyline points="16,7 22,7 22,13"></polyline>
                                </svg>
                            </div>
                            <p id="total-net-worth" class="text-2xl font-bold text-slate-800">$73,500</p>
                        </div>
                        
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-slate-500">Total Cash</h3>
                                <svg class="text-blue-500" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                </svg>
                            </div>
                            <p id="total-cash" class="text-2xl font-bold text-slate-800">$8,500</p>
                        </div>
                        
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-slate-500">Total Investments</h3>
                                <svg class="text-purple-500" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="22,7 13.5,15.5 8.5,10.5 2,17"></polyline>
                                    <polyline points="16,7 22,7 22,13"></polyline>
                                </svg>
                            </div>
                            <p id="total-investments" class="text-2xl font-bold text-slate-800">$65,000</p>
                        </div>
                    </div>

                    <!-- Current Month Cash Flow -->
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">This Month's Cash Flow</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center p-4 bg-green-50 rounded-lg">
                                <p class="text-sm text-slate-500 mb-1">Total Income</p>
                                <p id="current-month-income" class="text-xl font-bold text-green-600">$0</p>
                            </div>
                            <div class="text-center p-4 bg-red-50 rounded-lg">
                                <p class="text-sm text-slate-500 mb-1">Total Expenses</p>
                                <p id="current-month-expenses" class="text-xl font-bold text-red-600">$3,850</p>
                            </div>
                            <div class="text-center p-4 bg-blue-50 rounded-lg">
                                <p class="text-sm text-slate-500 mb-1">Net Flow</p>
                                <p id="current-month-net" class="text-xl font-bold text-red-600">-$3,850</p>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Wealth Projection Chart -->
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Wealth Projection (Next 12 Months)</h3>
                        <div class="h-64">
                            <canvas id="wealth-chart" width="400" height="200"></canvas>
                        </div>
                        <div class="flex justify-center mt-4 text-sm">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-blue-500 rounded"></div>
                                <span>Base Scenario</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accounts Tab -->
            <div id="content-accounts" class="tab-content">
                <div class="space-y-6">
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-slate-800">Account Balances</h3>
                            <button onclick="refreshAllBalances()" class="flex items-center space-x-2 px-3 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="1 4 1 10 7 10"></polyline>
                                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                                </svg>
                                <span>Update All Dates</span>
                            </button>
                        </div>
                        
                        <div class="space-y-8">
                            <!-- Up Bank -->
                            <div class="space-y-2">
                                <h4 class="text-md font-medium text-slate-800 border-b border-slate-200 pb-2">Up Bank</h4>
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-slate-700">Up Bank (Cash)</label>
                                    <div class="flex space-x-2">
                                        <input type="text" id="account-upBank" onchange="updateAccount('upBank', 'balance', this.value)" class="flex-1 px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="$0">
                                        <span id="date-upBank" class="px-3 py-2 text-sm text-slate-500 bg-slate-50 rounded-md">Updated: 2025-07-25</span>
                                    </div>
                                </div>
                            </div>

                            <!-- CommBank Group -->
                            <div class="space-y-2">
                                <h4 class="text-md font-medium text-slate-800 border-b border-slate-200 pb-2">CommBank</h4>
                                <div class="space-y-3">
                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-slate-700">CommBank Pocket (ETFs)</label>
                                        <div class="flex space-x-2">
                                            <input type="text" id="account-commBankPocket" onchange="updateAccount('commBankPocket', 'balance', this.value)" class="flex-1 px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="$0">
                                            <span id="date-commBankPocket" class="px-3 py-2 text-sm text-slate-500 bg-slate-50 rounded-md">Updated: 2025-07-24</span>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-slate-700">CommSec (Shares)</label>
                                        <div class="flex space-x-2">
                                            <input type="text" id="account-commsec" onchange="updateAccount('commsec', 'balance', this.value)" class="flex-1 px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="$0">
                                            <span id="date-commsec" class="px-3 py-2 text-sm text-slate-500 bg-slate-50 rounded-md">Updated: 2025-07-23</span>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-slate-700">CDIA (Cash)</label>
                                        <div class="flex space-x-2">
                                            <input type="text" id="account-commBankCDIA" onchange="updateAccount('commBankCDIA', 'balance', this.value)" class="flex-1 px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="$0">
                                            <span id="date-commBankCDIA" class="px-3 py-2 text-sm text-slate-500 bg-slate-50 rounded-md">Updated: 2025-08-04</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Account Totals -->
                        <div class="mt-8 pt-6 border-t border-slate-200">
                            <h4 class="text-md font-medium text-slate-800 mb-4">Account Totals</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="text-center p-4 bg-green-50 rounded-lg">
                                    <p class="text-sm text-slate-500 mb-1">Total Cash</p>
                                    <p id="accounts-total-cash" class="text-xl font-bold text-green-600">$0</p>
                                </div>
                                <div class="text-center p-4 bg-purple-50 rounded-lg">
                                    <p class="text-sm text-slate-500 mb-1">Total Investments</p>
                                    <p id="accounts-total-investments" class="text-xl font-bold text-purple-600">$0</p>
                                </div>
                                <div class="text-center p-4 bg-blue-50 rounded-lg">
                                    <p class="text-sm text-slate-500 mb-1">Grand Total</p>
                                    <p id="accounts-grand-total" class="text-xl font-bold text-blue-600">$0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Planning Tab -->
            <div id="content-planning" class="tab-content">
                <div class="space-y-6">
                    <!-- Income Configuration -->
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Income Configuration</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Annual salary (exc. super)</label>
                                <input type="text" id="base-salary" onchange="updateBaseSalary(this.value)" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Monthly take-home pay</label>
                                <div class="flex space-x-2">
                                    <input type="text" id="monthly-after-tax" readonly class="flex-1 px-3 py-2 border border-slate-300 rounded-md bg-slate-50">
                                    <button onclick="calculateIncome()" class="px-3 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 flex items-center" title="Calculate with Australian tax rates">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="1 4 1 10 7 10"></polyline>
                                            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Pay Date (Day of Month)</label>
                                <select id="pay-date" onchange="updatePayDate(this.value)" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                    <!-- Will be populated by JS -->
                                </select>
                            </div>
                            <div class="flex items-end">
                                <p class="text-sm text-slate-600">Uses Australian tax rates with tax-free threshold claimed</p>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Expenses -->
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Monthly Expenses</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Rent</label>
                                <input type="text" id="expense-rent" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Utilities</label>
                                <input type="text" id="expense-utilities" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Groceries</label>
                                <input type="text" id="expense-groceries" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Transport</label>
                                <input type="text" id="expense-transport" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Entertainment</label>
                                <input type="text" id="expense-entertainment" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Other</label>
                                <input type="text" id="expense-other" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-slate-50 rounded-lg">
                            <p class="text-sm text-slate-600">Total Monthly Expenses: <span id="total-monthly-expenses" class="font-semibold">$3,850</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Adjustments Tab -->
            <div id="content-adjustments" class="tab-content">
                <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-slate-800">Additional Financial Adjustments</h3>
                    </div>
                    
                    <div id="adjustments-list" class="space-y-3">
                        <p class="text-slate-500 text-center py-4">Adjustments feature will be added here</p>
                    </div>
                </div>
            </div>

            <!-- Projections Tab -->
            <div id="content-projections" class="tab-content">
                <div class="space-y-6">
                    <!-- Projection Controls -->
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-slate-800">Projection Settings</h3>
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-slate-700">Months to project:</label>
                                <select id="projection-months" class="px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                    <option value="6">6 months</option>
                                    <option value="12" selected>12 months</option>
                                    <option value="18">18 months</option>
                                    <option value="24">24 months</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Wealth Projection Chart -->
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Wealth Projection with Investment Scenarios</h3>
                        <div class="h-80">
                            <canvas id="detailed-wealth-chart" width="400" height="320"></canvas>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

<script>
// Update Functions
function updateAccountsDisplay() {
    document.getElementById('account-upBank').value = formatCurrency(appState.accounts.upBank.balance);
    document.getElementById('account-commBankPocket').value = formatCurrency(appState.accounts.commBankPocket.balance);
    document.getElementById('account-commsec').value = formatCurrency(appState.accounts.commsec.balance);
    document.getElementById('account-commBankCDIA').value = formatCurrency(appState.accounts.commBankCDIA.balance);
    
    document.getElementById('date-upBank').textContent = 'Updated: ' + appState.accounts.upBank.lastUpdated;
    document.getElementById('date-commBankPocket').textContent = 'Updated: ' + appState.accounts.commBankPocket.lastUpdated;
    document.getElementById('date-commsec').textContent = 'Updated: ' + appState.accounts.commsec.lastUpdated;
    document.getElementById('date-commBankCDIA').textContent = 'Updated: ' + appState.accounts.commBankCDIA.lastUpdated;
    
    const totals = getCurrentTotals();
    document.getElementById('accounts-total-cash').textContent = formatCurrency(totals.totalCash);
    document.getElementById('accounts-total-investments').textContent = formatCurrency(totals.totalInvestments);
    document.getElementById('accounts-grand-total').textContent = formatCurrency(totals.totalNetWorth);
}

function updatePlanningDisplay() {
    document.getElementById('base-salary').value = formatCurrency(appState.income.baseSalary);
    document.getElementById('monthly-after-tax').value = appState.income.isCalculated ? formatCurrency(appState.income.monthlySalary) : '$0';
    document.getElementById('pay-date').value = appState.income.payDate;
    
    let payDateOptions = '';
    for (let i = 1; i <= 28; i++) {
        payDateOptions += `<option value="${i}" ${appState.income.payDate === i ? 'selected' : ''}>${i}</option>`;
    }
    document.getElementById('pay-date').innerHTML = payDateOptions;
    
    Object.keys(appState.monthlyExpenses).forEach(key => {
        document.getElementById('expense-' + key).value = formatCurrency(appState.monthlyExpenses[key]);
    });
    
    const monthlyExpenseTotal = Object.values(appState.monthlyExpenses).reduce((sum, exp) => sum + exp, 0);
    document.getElementById('total-monthly-expenses').textContent = formatCurrency(monthlyExpenseTotal);
}

function updateProjectionsTab() {
    // This function will handle the projections tab updates
    console.log('Updating projections tab...');
}

function updateDashboard() {
    const currentTotals = getCurrentTotals();
    const currentMonthFlow = getCurrentMonthFlow();
    
    document.getElementById('total-net-worth').textContent = formatCurrency(currentTotals.totalNetWorth);
    document.getElementById('total-cash').textContent = formatCurrency(currentTotals.totalCash);
    document.getElementById('total-investments').textContent = formatCurrency(currentTotals.totalInvestments);
    
    document.getElementById('current-month-income').textContent = formatCurrency(currentMonthFlow.income);
    document.getElementById('current-month-expenses').textContent = formatCurrency(currentMonthFlow.expenses);
    document.getElementById('current-month-net').textContent = (currentMonthFlow.net >= 0 ? '+' : '') + formatCurrency(currentMonthFlow.net);
    
    const netElement = document.getElementById('current-month-net');
    netElement.className = `text-xl font-bold ${currentMonthFlow.net >= 0 ? 'text-green-600' : 'text-red-600'}`;
    
    createWealthChart();
}

function createWealthChart() {
    const ctx = document.getElementById('wealth-chart').getContext('2d');
    const projections = generateProjections();
    const chartData = projections.slice(0, 13);
    
    if (wealthChart) {
        wealthChart.destroy();
    }
    
    wealthChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.map(p => p.month),
            datasets: [
                {
                    label: 'Base Scenario',
                    data: chartData.map(p => p.total),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return '$' + (value/1000).toFixed(0) + 'k';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

// Initialization
function initializeApp() {
    console.log('Initializing Finance Tracker...');
    
    loadData();
    
    if (!appState.lastSyncTime) {
        appState.lastSyncTime = Date.now();
    }
    
    updateAccountsDisplay();
    updatePlanningDisplay();
    
    if (appState.income.baseSalary > 0 && !appState.income.isCalculated) {
        calculateIncome();
    }
    
    updateDashboard();
    
    console.log('Finance Tracker initialized successfully!');
}

// Event Listeners
document.addEventListener('DOMContentLoaded', initializeApp);
window.addEventListener('beforeunload', saveData);

console.log('All scripts loaded successfully');
</script>

</body>
</html>
